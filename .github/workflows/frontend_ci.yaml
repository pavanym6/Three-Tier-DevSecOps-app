---
#---------------------------------------------------------------------------------- ON
name: Frontend DevSecOps Pipeline

on:
    workflow_dispatch:
        # This allows you to run the workflow manually from the Actions tab
        # It will default to the 'main' branch unless you specify otherwise
#----------------------------------------------------------------------------------
jobs:
    frontend-ci:
        runs-on: ubuntu-latest
        env:
            AWS_REGION: us-east-1
            # Using your Account ID from the metadata provided
            AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
            ECR_REPOSITORY: "frontend"

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.MYGITHUB_TOKEN }}
                  fetch-depth: 0 # Good practice for SonarQube to see git history

            - name: Install Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"

            # --- SAST ---
            - name: SonarQube Scan
              uses: sonarsource/sonarqube-scan-action@master
              env:
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
              with:
                  projectBaseDir: Application-Code/frontend
                  args: >
                      -Dsonar.projectKey=frontend
                      -Dsonar.projectName=frontend
                      -Dsonar.sources=.

            # --- SCA & Lint ---
            - name: Trivy File Scan
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "Application-Code/frontend"
                  format: "table"
                  severity: 'HIGH,CRITICAL'

            # --- AWS & Docker ---
            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2

            - name: Build and Push Docker Image
              id: build-image
              env:
                  ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                  ECR_REPOSITORY: ${{ secrets.ECR_REPO1 }}
                  IMAGE_TAG: ${{ github.run_number }}
              run: |
                  cd Application-Code/frontend
                  docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
                  docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
                  echo "full_image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

            - name: Trivy Image Scan
              uses: aquasecurity/trivy-action@master
              with:
                image-ref: ${{ steps.build-image.outputs.full_image }}
                format: 'table'

            # --- GitOps Update ---
            - name: Update Deployment Manifest
              env:
                  FULL_IMAGE_NAME: ${{ steps.build-image.outputs.full_image }}
                  USER_EMAIL: ${{ secrets.GIT_EMAIL }}
                  USER_NAME: ${{ secrets.GIT_USERNAME }}
              run: |
                  # Use the variables from the env section
                  git config --global user.email "$USER_EMAIL"
                  git config --global user.name "$USER_NAME"
                  cd Kubernetes-Manifests-file/Frontend

                  # Perform the replacement
                  sed -i "s|image: .*frontend:.*|image: $FULL_IMAGE_NAME|g" deployment.yaml

                  # Verification check
                  echo "Verifying image update in deployment.yaml:"
                  grep "image:" deployment.yaml
                  git add deployment.yaml
                  git commit -m "Update frontend image to version $FULL_IMAGE_NAME"
                  git push origin HEAD:main  

